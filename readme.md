## Инструкция по развёртыванию и документация веб-сервиса мультиподписок на базе 3x-ui

### Оглавление
1. [Назначение и возможности](#1-назначение-и-возможности)
2. [Архитектура решения](#2-архитектура-решения)
3. [Функциональные блоки](#3-функциональные-блоки)
4. [API сервиса](#4-api-сервиса)
5. [Инструкция по развёртыванию на Ubuntu 22.04](#5-инструкция-по-развёртыванию-на-ubuntu-2204)
6. [Диагностика и решение проблем](#6-диагностика-и-решение-проблем)
7. [Руководство пользователя](#7-руководство-пользователя)
8. [Заключение](#8-заключение)

---

## 1. Назначение и возможности

Сервис предназначен для агрегации нескольких индивидуальных подписок (например, с панели 3x-ui) в единую **мультиподписку**. Это позволяет пользователю импортировать в клиент (Shadowrocket, v2rayTun, V2box) одну ссылку и получить все серверы из разных источников, автоматически обновляемые при изменении исходных подписок.

**Основные функции:**

- Управление мультиподписками (создание, редактирование, удаление).
- Добавление/удаление исходных подписок (URL) в составе мультиподписки.
- Генерация уникальной ссылки на мультиподписку для клиентов.
- Автоматическая агрегация контента исходных подписок при запросе мультиподписки.
- Поддержка клиентов, работающих со стандартным форматом (base64‑list или `text/plain`).

---

## 2. Архитектура решения

Сервис состоит из трёх основных компонентов:

- **Бэкенд** (Python/Flask) – REST API для управления мультиподписками и эндпоинт для выдачи агрегированной подписки.
- **Фронтенд** (HTML/CSS/JavaScript) – веб‑страницы для взаимодействия с пользователем.
- **База данных** (SQLite) – простое и надёжное хранение записей в файле.

**Принцип работы:**

1. Пользователь через веб‑интерфейс создаёт мультиподписку, указывая заголовок и список URL исходных подписок.
2. Сервер генерирует уникальный токен и сохраняет запись в БД.
3. По запросу на `https://multisub.domain/token` сервер:
   - поочерёдно загружает содержимое каждой исходной подписки;
   - объединяет все конфигурации прокси в один список;
   - отдаёт результат в формате `text/plain` (или base64, если это требуется для объединения).
4. Клиент по этой ссылке получает полный список серверов.

---

## 3. Функциональные блоки

### 3.1 Экранная форма создания

- Поле «Заголовок» (название для вашего удобства).
- Список URL исходных подписок (кнопки для добавления новых строк и удаления ненужных).
- Кнопка «Сгенерировать ссылку» – создаёт токен и показывает готовую ссылку для клиента.
- Кнопка «Сохранить» – фиксирует изменения в базе данных.

### 3.2 Список мультиподписок

- Таблица со всеми созданными подписками: заголовок, количество источников, ссылка (с кнопкой копирования).
- Кнопки «Добавить», «Изменить» и «Удалить» для каждой записи.

---

## 4. API сервиса

### 4.1 Эндпоинты управления (REST)

| Метод | Путь               | Описание                                 |
|-------|--------------------|------------------------------------------|
| GET   | `/api/multisubs`     | Список всех мультиподписок               |
| GET   | `/api/multisubs/<id>`| Получить данные одной подписки по ID     |
| POST  | `/api/multisubs`     | Создать новую запись                     |
| PUT   | `/api/multisubs/<id>`| Обновить существующую запись             |
| DELETE| `/api/multisubs/<id>`| Удалить запись                           |

*Примечание: `<id>` — это порядковый номер записи в базе данных.*

### 4.2 Эндпоинт для клиентов

- `GET /<token>` – возвращает объединённый список серверов.
- **Тип ответа:** `text/plain; charset=utf-8`

---

## 5. Инструкция по развёртыванию на Ubuntu 22.04

Инструкция рассчитана на выполнение команд через терминал (SSH). Вам не обязательно уметь программировать, достаточно следовать шагам.

### 5.1 Подготовка системы

Обновите пакеты и установите необходимые инструменты:
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl nginx certbot python3-pip python3-venv python3-certbot-nginx
```

### 5.2 Создание структуры папок

```bash
sudo mkdir -p /opt/multisub/static
sudo chown -R $USER:$USER /opt/multisub
cd /opt/multisub
```

### 5.3 Настройка Бэкенда (Python)

1. Создайте «виртуальное окружение», чтобы сервис работал в изолированной среде:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```
2. Установите необходимые библиотеки:
   ```bash
   pip install Flask Flask-CORS requests gunicorn
   ```
3. Создайте файл с кодом приложения:
   ```bash
   nano app.py
   ```
   *Вставьте в него код вашего Flask-приложения, нажмите `Ctrl+O`, `Enter`, затем `Ctrl+X`.*

### 5.4 Настройка автозапуска (Systemd)

Чтобы сервис включался сам при загрузке сервера и работал в фоне:
1. Убедитесь, что пользователь `www-data` имеет доступ к файлам:
   ```bash
   sudo chown -R www-data:www-data /opt/multisub
   ```
2. Создайте файл конфигурации:
   ```bash
   sudo nano /etc/systemd/system/multisub.service
   ```
3. Вставьте следующий текст:
   ```ini
   [Unit]
   Description=MultiSub Aggregator Service
   After=network.target

   [Service]
   User=www-data
   Group=www-data
   WorkingDirectory=/opt/multisub
   Environment="PATH=/opt/multisub/venv/bin"
   ExecStart=/opt/multisub/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 app:app
   Restart=always

   [Install]
   WantedBy=multi-user.target
   ```
4. Запустите сервис:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable multisub
   sudo systemctl start multisub
   ```
5. Проверьте статус:
   ```bash
   sudo systemctl status multisub
   ```
   *Должно быть `active (running)`. Если есть ошибки, смотрите логи: `journalctl -u multisub -n 50`*

### 5.5 Настройка Nginx (Веб-сервер)

1. Создайте файл настроек (замените `multisub.yourdomain.com` на ваш домен):
   ```bash
   sudo nano /etc/nginx/sites-available/multisub
   ```
2. Вставьте конфигурацию:
   ```nginx
   server {
       listen 80;
       server_name multisub.yourdomain.com; # ЗАМЕНИТЕ НА ВАШ ДОМЕН

       location /api/ {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }

       location / {
           root /opt/multisub/static;
           try_files $uri $uri/ @backend;
       }

       location @backend {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```
3. Активируйте настройки:
   ```bash
   sudo ln -s /etc/nginx/sites-available/multisub /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```
   *Если `nginx -t` показывает ошибки — проверьте синтаксис конфигурации.*

### 5.6 Настройка SSL (HTTPS)

**Важно:** Перед выполнением убедитесь, что:
- Домен `multisub.yourdomain.com` указывает на IP вашего сервера (проверьте через `nslookup multisub.yourdomain.com`).
- Порты 80 и 443 открыты в файрволе.

Получите SSL-сертификат:
```bash
sudo certbot --nginx -d multisub.yourdomain.com
```
*Следуйте инструкциям на экране (введите email, согласитесь с условиями).*

После успешной установки Certbot автоматически обновит конфигурацию Nginx для работы по HTTPS.

Проверьте автообновление сертификата:
```bash
sudo certbot renew --dry-run
```

---

## 6. Диагностика и решение проблем

Если сервис не работает, проверьте следующее:

### Команды проверки
- **Статус бэкенда:** `sudo systemctl status multisub` (должно быть `active (running)`).
- **Логи ошибок бэкенда:** `sudo journalctl -u multisub -n 50 --no-pager`
- **Проверка Nginx:** `sudo nginx -t` и `sudo systemctl status nginx`
- **Проверка портов:** `sudo netstat -tlnp | grep -E ':(80|443|5000)'` (должны быть открыты 80, 443 для Nginx и 5000 для Flask).
- **Тест локального API:** `curl http://127.0.0.1:5000/api/multisubs` (должен вернуть JSON или ошибку Flask, но не "Connection refused").

### Типовые проблемы

**1. Ошибка 502 Bad Gateway**
- Причина: Бэкенд не запущен или недоступен.
- Решение: 
  ```bash
  sudo systemctl status multisub
  sudo journalctl -u multisub -n 100 --no-pager
  ```
  Проверьте права доступа: `ls -la /opt/multisub`

**2. Ошибка "Permission denied" при запуске сервиса**
- Причина: Пользователь `www-data` не имеет доступа к файлам.
- Решение:
  ```bash
  sudo chown -R www-data:www-data /opt/multisub
  sudo systemctl restart multisub
  ```

**3. Не загружаются данные из 3x-ui**
- Причина: Сервер не может подключиться к источникам.
- Решение: Проверьте доступность:
  ```bash
  curl -I <URL_подписки>
  ```
  Если ошибка — проверьте файрвол или DNS.

**4. SSL Error / Certbot не может выдать сертификат**
- Причина: Домен не указывает на сервер или порт 80 закрыт.
- Решение:
  ```bash
  nslookup multisub.yourdomain.com
  sudo ufw status
  sudo ufw allow 80/tcp
  sudo ufw allow 443/tcp
  ```

**5. Сервис не стартует после перезагрузки**
- Причина: Не включен автозапуск.
- Решение:
  ```bash
  sudo systemctl enable multisub
  sudo systemctl start multisub
  ```

---

## 7. Руководство пользователя

1. Откройте ваш домен в браузере.
2. Нажмите **«Добавить»**, введите название и вставьте URL ваших подписок.
3. Нажмите **«Сгенерировать ссылку»**, затем **«Сохранить»**.
4. Скопируйте полученную ссылку.
5. Вставьте её в Shadowrocket, v2rayTun или V2box как обычную подписку.

---

## 8. Заключение

Теперь у вас есть собственный сервис-агрегатор. Он избавляет от необходимости добавлять десятки ссылок в клиент — достаточно одной ссылки, которая объединяет всё самое лучшее из ваших источников.

Для обновления кода в будущем просто отредактируйте `app.py` и перезапустите сервис командой:
`sudo systemctl restart multisub`
